name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-action@stable

      - name: Run tests
        run: cargo test --verbose

      - name: Build release
        run: cargo build --release

      - name: Create distribution
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="aarch64-apple-darwin"
          NAME="monokit-${VERSION}-${ARCH}"

          mkdir -p dist/${NAME}
          cp target/release/monokit dist/${NAME}/
          cp -r sc dist/${NAME}/

          cd dist
          tar -czvf ${NAME}.tar.gz ${NAME}
          shasum -a 256 ${NAME}.tar.gz > ${NAME}.tar.gz.sha256

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.tar.gz
            dist/*.sha256
          generate_release_notes: true

      - name: Update Homebrew Formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          SHA256=$(curl -sL https://github.com/${{ github.repository }}/archive/refs/tags/v${VERSION}.tar.gz | shasum -a 256 | cut -d' ' -f1)

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/stolmine/homebrew-monokit.git
          cd homebrew-monokit

          sed -i '' "s|url \".*\"|url \"https://github.com/stolmine/monokit/archive/refs/tags/v${VERSION}.tar.gz\"|" Formula/monokit.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/monokit.rb

          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/monokit.rb
          git commit -m "Update monokit to v${VERSION}"
          git push
