name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SuperCollider
        run: |
          brew install --cask supercollider
          # Wait for installation to complete
          sleep 5

      - name: Install sc3-plugins
        run: |
          # Download and install sc3-plugins for SVF filter
          SC3_VERSION="3.13.0"
          curl -L -o sc3-plugins.zip "https://github.com/supercollider/sc3-plugins/releases/download/Version-${SC3_VERSION}/sc3-plugins-3.13.0-macOS.zip"
          unzip sc3-plugins.zip
          mkdir -p ~/Library/Application\ Support/SuperCollider/Extensions/
          cp -r SC3plugins ~/Library/Application\ Support/SuperCollider/Extensions/

      - name: Compile SynthDefs
        run: |
          # Run sclang to compile synthdefs
          cd build_scripts
          /Applications/SuperCollider.app/Contents/MacOS/sclang compile_synthdefs.scd || true
          ls -la ../sc/synthdefs/

      - name: Run tests
        run: cargo test --verbose

      - name: Build release bundle
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          CODESIGN=1 ./scripts/bundle.sh "${VERSION}"

      - name: Create tarball
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="aarch64-apple-darwin"
          NAME="monokit-${VERSION}-${ARCH}"

          cd dist/bundle
          tar -czvf "${NAME}.tar.gz" "${NAME}"
          shasum -a 256 "${NAME}.tar.gz" > "${NAME}.tar.gz.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bundle
          path: |
            dist/bundle/*.tar.gz
            dist/bundle/*.sha256

  release:
    needs: build-macos
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-bundle
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/*.tar.gz
            dist/*.sha256
          generate_release_notes: true
          body: |
            ## Installation

            Download the tarball for your platform, extract, and run:

            ```bash
            tar -xzf monokit-*.tar.gz
            cd monokit-*
            ./monokit
            ```

            **Note:** On first run, macOS may require you to allow the app in Security & Privacy settings.

            ## What's Included

            This is a self-contained bundle (~16MB) that includes:
            - monokit binary
            - scsynth audio engine
            - All required plugins and SynthDefs

            No separate SuperCollider installation required!

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts for SHA256
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-bundle
          path: dist/

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="aarch64-apple-darwin"
          TARBALL="monokit-${VERSION}-${ARCH}.tar.gz"
          URL="https://github.com/stolmine/monokit/releases/download/v${VERSION}/${TARBALL}"

          # Get SHA256 from artifact
          SHA256=$(cat dist/${TARBALL}.sha256 | cut -d' ' -f1)

          # Clone homebrew tap
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/stolmine/homebrew-monokit.git
          cd homebrew-monokit

          # Update formula
          sed -i "s|version \".*\"|version \"${VERSION}\"|" Formula/monokit.rb
          sed -i "s|url \"https://github.com/stolmine/monokit/releases/download/v.*/monokit-.*-aarch64-apple-darwin.tar.gz\"|url \"${URL}\"|" Formula/monokit.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/monokit.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/monokit.rb
          git commit -m "Update monokit to v${VERSION}"
          git push
