name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SuperCollider
        run: |
          # Retry on transient failures (504 errors, etc.)
          for i in 1 2 3; do
            if brew install --cask supercollider; then
              break
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          # Wait for installation to complete
          sleep 5

      - name: Install sc3-plugins
        run: |
          # Download and install sc3-plugins for SVF filter
          curl -L -o sc3-plugins.zip "https://github.com/supercollider/sc3-plugins/releases/download/Version-3.13.0/sc3-plugins-3.13.0-macOS.zip"
          unzip sc3-plugins.zip
          mkdir -p ~/Library/Application\ Support/SuperCollider/Extensions/
          cp -r sc3-plugins/SC3plugins ~/Library/Application\ Support/SuperCollider/Extensions/

      - name: Install mi-UGens
        run: |
          # Download and install mi-UGens for Plaits integration
          curl -L -o mi-UGens.zip "https://github.com/v7b1/mi-UGens/releases/download/v0.0.8/mi-UGens-macOS.zip"
          unzip mi-UGens.zip
          mkdir -p ~/Library/Application\ Support/SuperCollider/Extensions/
          cp -r mi-UGens ~/Library/Application\ Support/SuperCollider/Extensions/

      - name: Compile SynthDefs
        run: |
          # Run sclang to compile synthdefs
          # macOS requires running sclang from its own directory - see docs/SCLANG_MACOS_FIX.md
          REPO_ROOT="$(pwd)"
          (cd /Applications/SuperCollider.app/Contents/MacOS && \
           ./sclang "${REPO_ROOT}/build_scripts/compile_synthdefs.scd") || true
          ls -la sc/synthdefs/

      - name: Run tests
        run: cargo test --verbose

      - name: Build release bundle
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          CODESIGN=1 ./scripts/bundle.sh "${VERSION}"

      - name: Create tarball
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="aarch64-apple-darwin"
          NAME="monokit-${VERSION}-${ARCH}"

          cd dist/bundle
          tar -czvf "${NAME}.tar.gz" "${NAME}"
          shasum -a 256 "${NAME}.tar.gz" > "${NAME}.tar.gz.sha256"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-bundle
          path: |
            dist/bundle/*.tar.gz
            dist/bundle/*.sha256

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libasound2-dev libjack-jackd2-dev libdbus-1-dev pkg-config libqt5gui5

      - name: Install SuperCollider
        run: |
          sudo apt-get install -y supercollider sc3-plugins

      - name: Install mi-UGens
        run: |
          mkdir -p ~/.local/share/SuperCollider/Extensions
          curl -L -o mi-UGens.zip "https://github.com/v7b1/mi-UGens/releases/download/v0.0.8/mi-UGens-Linux.zip"
          unzip mi-UGens.zip -d ~/.local/share/SuperCollider/Extensions/

      - name: Compile SynthDefs
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          # Compile synthdefs (QT_QPA_PLATFORM=offscreen avoids X11 requirement)
          timeout 120 sclang -D build_scripts/compile_synthdefs.scd || true
          ls -la sc/synthdefs/

      - name: Run tests
        run: cargo test --verbose

      - name: Build release bundle
        env:
          QT_QPA_PLATFORM: offscreen
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ./scripts/bundle-linux.sh "${VERSION}"

      - name: Create tarball
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="x86_64-unknown-linux-gnu"
          NAME="monokit-${VERSION}-${ARCH}"

          cd dist/bundle
          tar -czvf "${NAME}.tar.gz" "${NAME}"
          sha256sum "${NAME}.tar.gz" > "${NAME}.tar.gz.sha256"

      - name: Build AppImage
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ./packaging/appimage/build-appimage.sh "${VERSION}"
          cd dist/appimage
          sha256sum Monokit-${VERSION}-x86_64.AppImage > Monokit-${VERSION}-x86_64.AppImage.sha256

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64-bundle
          path: |
            dist/bundle/*.tar.gz
            dist/bundle/*.sha256
            dist/appimage/*.AppImage
            dist/appimage/*.sha256

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install SuperCollider
        shell: pwsh
        run: |
          # Download and extract SuperCollider (using ZIP for predictable filename)
          $scVersion = "3.14.1"
          $scZip = "SuperCollider-$scVersion-win64.zip"
          $scUrl = "https://github.com/supercollider/supercollider/releases/download/Version-$scVersion/$scZip"

          Write-Host "Downloading SuperCollider $scVersion..."
          Invoke-WebRequest -Uri $scUrl -OutFile $scZip

          Write-Host "Extracting SuperCollider..."
          New-Item -ItemType Directory -Force -Path "C:\SuperCollider" | Out-Null
          Expand-Archive -Path $scZip -DestinationPath "C:\SuperCollider" -Force

          # The ZIP extracts to "SuperCollider" subfolder (not versioned)
          # Verify installation
          if (Test-Path "C:\SuperCollider\SuperCollider\scsynth.exe") {
            Write-Host "SuperCollider installed successfully"
            Write-Host "Plugins available:"
            Get-ChildItem "C:\SuperCollider\SuperCollider\plugins\*.scx" |
              Where-Object { $_.Name -notmatch 'supernova' } |
              ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Error "SuperCollider installation failed"
            Write-Host "Directory contents:"
            Get-ChildItem "C:\SuperCollider" -Recurse -Depth 2 | Select-Object FullName
            exit 1
          }

      - name: Install sc3-plugins
        shell: pwsh
        run: |
          $sc3Version = "3.13.0"
          $sc3Zip = "sc3-plugins-$sc3Version-Windows-64bit.zip"
          $sc3Url = "https://github.com/supercollider/sc3-plugins/releases/download/Version-$sc3Version/$sc3Zip"

          Write-Host "Downloading sc3-plugins..."
          Invoke-WebRequest -Uri $sc3Url -OutFile $sc3Zip

          $extDir = "$env:LOCALAPPDATA\SuperCollider\Extensions"
          New-Item -ItemType Directory -Force -Path $extDir | Out-Null

          Write-Host "Extracting sc3-plugins..."
          Expand-Archive -Path $sc3Zip -DestinationPath $extDir -Force

          # Verify
          if (Test-Path "$extDir\SC3plugins") {
            Write-Host "sc3-plugins installed successfully"
          } else {
            Write-Error "sc3-plugins installation failed"
            exit 1
          }

      - name: Install mi-UGens
        shell: pwsh
        run: |
          $miVersion = "0.0.8"
          $miZip = "mi-UGens-Windows.zip"
          $miUrl = "https://github.com/v7b1/mi-UGens/releases/download/v$miVersion/$miZip"

          Write-Host "Downloading mi-UGens..."
          Invoke-WebRequest -Uri $miUrl -OutFile $miZip

          $extDir = "$env:LOCALAPPDATA\SuperCollider\Extensions"
          New-Item -ItemType Directory -Force -Path $extDir | Out-Null

          Write-Host "Extracting mi-UGens..."
          Expand-Archive -Path $miZip -DestinationPath $extDir -Force

          # Verify
          if (Test-Path "$extDir\mi-UGens") {
            Write-Host "mi-UGens installed successfully"
          } else {
            Write-Error "mi-UGens installation failed"
            exit 1
          }

      - name: Compile SynthDefs
        shell: pwsh
        run: |
          $sclang = "C:\SuperCollider\SuperCollider\sclang.exe"

          Write-Host "Compiling SynthDefs..."
          & $sclang "build_scripts\compile_synthdefs.scd"

          # Wait for sclang to finish and clean up
          Start-Sleep -Seconds 5
          Get-Process sclang -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue

          # Verify synthdefs
          $synthdefs = Get-ChildItem "sc\synthdefs\*.scsyndef" -ErrorAction SilentlyContinue
          if ($synthdefs.Count -gt 0) {
            Write-Host "Compiled $($synthdefs.Count) SynthDefs"
            $synthdefs | ForEach-Object { Write-Host "  - $($_.Name)" }
          } else {
            Write-Error "SynthDef compilation failed"
            exit 1
          }

      - name: Run tests
        run: cargo test --verbose

      - name: Build release bundle
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          .\scripts\bundle-windows.ps1 -Version $version

      - name: Create zip archive
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $arch = "x86_64-pc-windows-msvc"
          $name = "monokit-$version-$arch"

          cd dist\bundle
          Compress-Archive -Path $name -DestinationPath "$name.zip"

          # Create SHA256 checksum
          $hash = (Get-FileHash "$name.zip" -Algorithm SHA256).Hash.ToLower()
          "$hash  $name.zip" | Out-File -Encoding ASCII "$name.zip.sha256"

      - name: Create self-extracting exe (SFX)
        shell: pwsh
        run: |
          $version = "${{ github.ref_name }}".TrimStart('v')
          $arch = "x86_64-pc-windows-msvc"
          $name = "monokit-$version-$arch"
          $repoRoot = $PWD.Path

          # Download 7-Zip extra (contains SFX module)
          $7zUrl = "https://www.7-zip.org/a/7z2408-extra.7z"
          Invoke-WebRequest -Uri $7zUrl -OutFile "7z-extra.7z"

          # Install 7-Zip to extract the extra package
          choco install 7zip -y
          & "C:\Program Files\7-Zip\7z.exe" x "7z-extra.7z" -o"7z-extra" -y

          # List what was extracted
          Write-Host "7z-extra contents:"
          Get-ChildItem -Path "$repoRoot\7z-extra" -Recurse | ForEach-Object { Write-Host "  $($_.FullName)" }

          # Find SFX stub
          $sfxStub = Get-ChildItem -Path "$repoRoot\7z-extra" -Filter "7zS*.sfx" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          if (-not $sfxStub) {
            # Maybe it's named differently - look for any .sfx
            $sfxStub = Get-ChildItem -Path "$repoRoot\7z-extra" -Filter "*.sfx" -Recurse | Select-Object -First 1 -ExpandProperty FullName
          }
          if (-not $sfxStub) {
            # Check if 7z.sfx exists in the installed 7-Zip
            $sfxStub = "C:\Program Files\7-Zip\7z.sfx"
            if (-not (Test-Path $sfxStub)) {
              Write-Host "WARNING: No SFX stub found, skipping SFX creation"
              exit 0
            }
          }
          Write-Host "Using SFX stub: $sfxStub"

          # Create SFX config
          $configFile = "$repoRoot\sfx_config.txt"
          $sfxConfig = ";!@Install@!UTF-8!`nTitle=`"Monokit $version`"`nRunProgram=`"monokit.exe`"`nDirectory=`"%%T\monokit-$version`"`n;!@InstallEnd@!"
          [System.IO.File]::WriteAllText($configFile, $sfxConfig)

          # Create 7z archive of the bundle
          $bundleDir = "$repoRoot\dist\bundle"
          $archiveFile = "$bundleDir\$name.7z"
          & "C:\Program Files\7-Zip\7z.exe" a -t7z -mx=9 $archiveFile "$bundleDir\$name\*"

          # Combine SFX stub + config + archive
          Write-Host "Creating SFX executable..."
          $sfxBytes = [System.IO.File]::ReadAllBytes($sfxStub)
          $configBytes = [System.IO.File]::ReadAllBytes($configFile)
          $archiveBytes = [System.IO.File]::ReadAllBytes($archiveFile)
          $combined = $sfxBytes + $configBytes + $archiveBytes
          $exeFile = "$bundleDir\$name.exe"
          [System.IO.File]::WriteAllBytes($exeFile, $combined)

          # Verify and create SHA256 checksum
          if (Test-Path $exeFile) {
            $hash = (Get-FileHash $exeFile -Algorithm SHA256).Hash.ToLower()
            "$hash  $name.exe" | Out-File -Encoding ASCII "$bundleDir\$name.exe.sha256"
            $sizeMB = (Get-Item $exeFile).Length / 1MB
            Write-Host "Created SFX: $name.exe ($([math]::Round($sizeMB, 2)) MB)"
          } else {
            Write-Error "Failed to create SFX executable"
            exit 1
          }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64-bundle
          path: |
            dist/bundle/*.zip
            dist/bundle/*.sha256
            dist/bundle/*.exe

  release:
    needs: [build-macos, build-linux, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-bundle
          path: dist/

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-x64-bundle
          path: dist/

      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-x64-bundle
          path: dist/

      - name: Get bundle sizes
        id: bundle_size
        run: |
          MACOS_SIZE=$(find dist -name '*darwin*.tar.gz' -exec du -h {} \; 2>/dev/null | cut -f1 || echo "N/A")
          LINUX_SIZE=$(find dist -name '*linux*.tar.gz' -exec du -h {} \; 2>/dev/null | cut -f1 || echo "N/A")
          WINDOWS_SIZE=$(find dist -name '*windows*.zip' -exec du -h {} \; 2>/dev/null | cut -f1 || echo "N/A")
          echo "macos_size=$MACOS_SIZE" >> $GITHUB_OUTPUT
          echo "linux_size=$LINUX_SIZE" >> $GITHUB_OUTPUT
          echo "windows_size=$WINDOWS_SIZE" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/**/*.tar.gz
            dist/**/*.sha256
            dist/**/*.AppImage
            dist/**/*.zip
            dist/**/*.exe
          generate_release_notes: true
          body: |
            ## Installation

            ### macOS (Apple Silicon)
            ```bash
            tar -xzf monokit-*-aarch64-apple-darwin.tar.gz
            cd monokit-*-aarch64-apple-darwin
            ./monokit
            ```
            **Note:** On first run, macOS may require you to allow the app in Security & Privacy settings.

            ### Linux (x86_64) - Tarball
            ```bash
            tar -xzf monokit-*-x86_64-unknown-linux-gnu.tar.gz
            cd monokit-*-x86_64-unknown-linux-gnu
            ./monokit
            ```

            ### Linux (x86_64) - AppImage
            ```bash
            chmod +x Monokit-*-x86_64.AppImage
            ./Monokit-*-x86_64.AppImage
            ```

            **Note:** Linux builds require PipeWire or JACK for audio. Audio auto-connects to PipeWire if available.

            ### Windows (x86_64) - Portable EXE (Recommended)
            1. Download `monokit-*-x86_64-pc-windows-msvc.exe`
            2. Double-click to run (extracts to temp and launches automatically)

            Single portable file, similar to Linux AppImage.

            ### Windows (x86_64) - ZIP Archive
            1. Extract `monokit-*-x86_64-pc-windows-msvc.zip`
            2. Open the extracted folder
            3. Run `monokit.exe`

            Use this if you prefer to keep the files in a permanent location.

            **Note:** For low-latency audio on Windows, ASIO drivers are recommended (e.g., ASIO4ALL or your audio interface's ASIO driver).

            **Config location:** `%APPDATA%\monokit\` (persists across runs)

            ## What's Included

            Self-contained bundles (macOS: ${{ steps.bundle_size.outputs.macos_size }}, Linux: ${{ steps.bundle_size.outputs.linux_size }}, Windows: ${{ steps.bundle_size.outputs.windows_size }}) including:
            - monokit binary
            - scsynth audio engine
            - All required plugins and SynthDefs

            No separate SuperCollider installation required!

  update-homebrew:
    needs: release
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts for SHA256
        uses: actions/download-artifact@v4
        with:
          name: macos-arm64-bundle
          path: dist/

      - name: Update Homebrew formula
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          ARCH="aarch64-apple-darwin"
          TARBALL="monokit-${VERSION}-${ARCH}.tar.gz"
          URL="https://github.com/stolmine/monokit/releases/download/v${VERSION}/${TARBALL}"

          # Get SHA256 from artifact
          SHA256=$(cat dist/${TARBALL}.sha256 | cut -d' ' -f1)

          # Clone homebrew tap
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/stolmine/homebrew-monokit.git
          cd homebrew-monokit

          # Update formula
          sed -i "s|version \".*\"|version \"${VERSION}\"|" Formula/monokit.rb
          sed -i "s|url \"https://github.com/stolmine/monokit/releases/download/v.*/monokit-.*-aarch64-apple-darwin.tar.gz\"|url \"${URL}\"|" Formula/monokit.rb
          sed -i "s|sha256 \".*\"|sha256 \"${SHA256}\"|" Formula/monokit.rb

          # Commit and push
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/monokit.rb
          git commit -m "Update monokit to v${VERSION}"
          git push
