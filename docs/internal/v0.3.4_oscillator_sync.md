# Oscillator Sync Plan

## Overview

Add hard oscillator sync where the modulator resets the primary oscillator's phase.

## Background

### What is Oscillator Sync?

Hard sync forces a "slave" oscillator to restart its cycle whenever a "master" oscillator completes a cycle. This creates distinctive timbres - the classic "sync sweep" sound when sweeping the slave frequency.

### Current Architecture

- **Primary oscillator**: SinOsc, LFTri, or LFSaw (selected by `pw`)
- **Modulator oscillator**: SinOsc, LFTri, LFSaw, or SinOscFB (selected by `mw`)
- **Relationship**: Modulator provides FM to primary (frequency modulation)

### Proposed Sync Architecture

- **Master**: Modulator oscillator (mf frequency)
- **Slave**: Primary oscillator (pf frequency)
- **Effect**: Primary resets phase on modulator zero-crossing

## Design

### New Parameters

| Parameter | Command | Range | Default | Description |
|-----------|---------|-------|---------|-------------|
| `sy` | `SY` / `SYNC` | 0-16383 | 0 | Sync amount (dry/wet) |
| `sm` | `SM` / `SYNC.MOD` | 0-1 | 0 | Sync mode |

### Sync Modes (sm)
- 0: Hard sync (instant phase reset)
- 1: Soft sync (phase reset with smoothing)

## Implementation

### Task 1: SynthDef Changes

**File:** `sc/monokit_server.scd`

1. Add parameters:
```supercollider
// Sync parameters
sy = 0,      // Sync amount (0-16383)
sm = 0,      // Sync mode (0=hard, 1=soft)
```

2. Create synced oscillator variant (after modOsc, ~line 228):
```supercollider
// Sync implementation using SyncSaw
var sySmooth = Lag.kr(sy / 16383, 0.01);
var syncFreq = modulatorFreq;  // Master frequency

// Synced primary oscillator (slave)
var syncedOsc = Select.ar(pw.clip(0, 2).round, [
    // Synced sine approximation via SyncSaw + waveshaping
    SyncSaw.ar(syncFreq, primaryFreq).sin,
    // Synced triangle approximation
    SyncSaw.ar(syncFreq, primaryFreq).fold2(0.5) * 2,
    // Synced saw (native)
    SyncSaw.ar(syncFreq, primaryFreq)
]);

// Soft sync option - phase modulation approach
var softSyncOsc = Select.ar(pw.clip(0, 2).round, [
    SinOsc.ar(primaryFreq, SinOsc.ar(syncFreq) * 2pi),
    LFTri.ar(primaryFreq, SinOsc.ar(syncFreq)),
    LFSaw.ar(primaryFreq, SinOsc.ar(syncFreq))
]);

// Select between hard and soft sync
var syncOsc = Select.ar(sm.clip(0, 1).round, [
    syncedOsc,
    softSyncOsc
]);
```

3. Mix synced and unsynced signals:
```supercollider
// Replace current primaryOsc line with:
var unsyncedOsc = Select.ar(pw.clip(0, 2).round, [
    SinOsc.ar(primaryFreq + (modOsc * fmAmount)),
    LFTri.ar(primaryFreq + (modOsc * fmAmount)),
    LFSaw.ar(primaryFreq + (modOsc * fmAmount))
]);

// Crossfade between unsynced and synced
primaryOsc = (unsyncedOsc * (1 - sySmooth)) + (syncOsc * sySmooth);
```

### Alternative: Using Phasor Reset

If SyncSaw doesn't provide desired character:

```supercollider
// Master phasor
var masterPhasor = Phasor.ar(0, syncFreq * SampleDur.ir, 0, 1);
var masterTrig = HPZ1.ar(masterPhasor) < 0;  // Trigger on wrap

// Slave with reset
var slavePhasor = Phasor.ar(masterTrig, primaryFreq * SampleDur.ir, 0, 1);

// Generate waveforms from phasor
var syncedOsc = Select.ar(pw.clip(0, 2).round, [
    sin(slavePhasor * 2pi),                    // Sine
    (slavePhasor * 4 - 2).fold2(1),            // Triangle
    slavePhasor * 2 - 1                         // Saw
]);
```

### Task 2: Rust Command Handlers

**File:** `src/commands/synth/oscillators.rs` (or new sync.rs)

```rust
// Sync amount (0-16383)
define_synth_param!(
    handle_sy, "sy", "SY", "SYNC AMOUNT",
    0, 16383, |v| v as i32,
    "Failed to parse sync amount"
);

// Sync mode (0-1)
define_synth_param!(
    handle_sm, "sm", "SM", "SYNC MODE",
    0, 1, |v| v as i32,
    "Failed to parse sync mode"
);
```

### Task 3: Add Aliases

**File:** `src/commands/aliases.rs`

```rust
m.insert("SYNC.AMT", "SY");
m.insert("SYNC.MOD", "SM");
```

Note: `SYNC` is already used for state reset. Use `SY` as primary.

### Task 4: Update Help System

**File:** `src/ui/pages/help_content.rs`

Add to OSCILLATOR section:
```
# OSCILLATOR SYNC
  SY / SYNC.AMT <0-16383>  SYNC AMOUNT (DRY/WET)
  SM / SYNC.MOD <0|1>      SYNC MODE
                           0=HARD, 1=SOFT
```

### Task 5: Add to Reset

**File:** `src/commands/system/misc.rs`

```rust
// In handle_rst
send_osc("sy", 0);
send_osc("sm", 0);
```

## Signal Flow with Sync

```
                    ┌─────────────────────────────────┐
                    │         MODULATOR OSC           │
mf ────────────────>│  (master for sync)              │
mw ────────────────>│                                 │
                    └──────────┬──────────────────────┘
                               │
            ┌──────────────────┼──────────────────────┐
            │                  │ sync trigger         │
            │                  v                      │
            │         ┌────────────────┐              │
pf ─────────┼────────>│  PRIMARY OSC   │              │
pw ─────────┼────────>│  (slave)       │              │
            │         └───────┬────────┘              │
            │                 │                       │
            │    ┌────────────┴────────────┐          │
            │    │                         │          │
            │    v                         v          │
            │  unsynced                  synced       │
            │    │                         │          │
            │    └──────────┬──────────────┘          │
            │               │                         │
sy ─────────┼──────────────>│ crossfade               │
            │               v                         │
            │         primaryOsc                      │
            └─────────────────────────────────────────┘
```

## Files to Modify

| File | Changes |
|------|---------|
| `sc/monokit_server.scd` | Add sync oscillators |
| `src/commands/synth/oscillators.rs` | Add SY, SM handlers |
| `src/commands/aliases.rs` | Add aliases |
| `src/commands/mod.rs` | Route commands |
| `src/commands/system/misc.rs` | Add to RST |
| `src/ui/pages/help_content.rs` | Add help section |
| `build_scripts/compile_synthdefs.scd` | Update compiled |

## Testing

1. Sync amount 0 = normal FM behavior
2. Sync amount max = full sync character
3. Hard vs soft sync audible difference
4. Sweep pf while synced for classic sound
5. Various pw waveforms with sync
6. Sync + FM combined
7. RST clears sync parameters
