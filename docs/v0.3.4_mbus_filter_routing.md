# ModBus Filter Routing Fix Plan

## Overview

MF.F (mod → filter cutoff) exists in SynthDef but the Rust handler is not working correctly. This plan covers debugging/fixing the existing implementation and adding filter resonance routing.

## Current State

### SynthDef (Working)
- `mf_f` parameter exists at line 50
- Wired into filter cutoff calculation at line 265:
  ```supercollider
  filterCutoff = fcSmooth + ... + (modBus * mf_f * 5000);
  ```

### Rust (Needs Investigation)
- Handler defined: `src/commands/synth/filter.rs:15`
- Command routed: `src/commands/mod.rs:483-485`
- Alias exists: `ROUT.MF` → `MF.F`
- Validation includes MF.F: `src/commands/validate.rs:894`
- RST resets mf_f: `src/commands/system/misc.rs:217`

## Issue: MF.F Not Working

**Symptoms:** Command fails or doesn't affect audio as expected.

**Investigation Tasks:**
1. Test `MF.F 1` - does it send OSC?
2. Test `MF.F` query - does it show current state?
3. Check define_bool_param macro output format
4. Verify OSC message format matches SynthDef expectation
5. Test with `MB 8000` to ensure modbus has signal

## Implementation Tasks

### Task 1: Debug MF.F Handler

Test and fix the existing handler:

```bash
# In monokit, test these commands:
MB 8000     # Set modbus amount
MF.F 1      # Enable mod → filter
FC 1000     # Set filter to hear sweep
```

If no effect, add debug logging to trace OSC message.

### Task 2: Verify OSC Message Format

Check that `define_bool_param!` sends correct format:
- Should send: `/n_set <nodeID> mf_f 0` or `/n_set <nodeID> mf_f 1`
- Verify integer vs float expectation in SynthDef

### Task 3: Add Filter Resonance Routing (MFQ)

**SynthDef Changes** (`sc/monokit_server.scd`):

1. Add parameter:
```supercollider
mf_q = 0,    // ModBus -> filter resonance
```

2. Modify filter Q calculation:
```supercollider
// Current:
filterQ = ((fqSmooth / 16383) * 0.9 + 0.1);

// New:
filterQ = ((fqSmooth / 16383) * 0.9 + 0.1) + (modBus * mf_q * 0.5);
filterQ = filterQ.clip(0.1, 1.0);
```

**Rust Changes:**

1. Add handler in `src/commands/synth/filter.rs`:
```rust
define_bool_param!(handle_mfq, "mf_q", "MFQ", "MOD -> FILTER RES", "Failed to parse mod to filter res");
```

2. Add alias in `src/commands/aliases.rs`:
```rust
m.insert("ROUT.FQ", "MFQ");
```

3. Route command in `src/commands/mod.rs`

### Task 4: Update Help System

**File:** `src/ui/pages/help_content.rs`

```
# MODBUS ROUTING
  MP <0|1>       MOD -> PRIMARY FREQ
  MD <0|1>       MOD -> MODULATOR FREQ
  MT <0|1>       MOD -> TRACKING
  MA <0|1>       MOD -> AMPLITUDE
  MM <0|1>       MOD -> OSC MIX
  MF.F <0|1>     MOD -> FILTER CUTOFF
  MFQ <0|1>      MOD -> FILTER RES (NEW)
```

## Files to Modify

| File | Changes |
|------|---------|
| `sc/monokit_server.scd` | Add mf_q param, wire to filter Q |
| `src/commands/synth/filter.rs` | Fix MF.F, add MFQ handler |
| `src/commands/mod.rs` | Route MFQ |
| `src/commands/aliases.rs` | Add ROUT.FQ alias |
| `src/ui/pages/help_content.rs` | Update help |
| `build_scripts/compile_synthdefs.scd` | Mirror SynthDef changes |

## Testing

1. **Debug MF.F** - identify and fix current errors
2. **Verify all routes** - MP, MD, MT, MA, MM with MB amount
3. **Test new MFQ** - filter resonance responds to modbus
4. **Combined routing** - multiple targets enabled simultaneously
