# Noise Source Integration Plan

## Overview

Add a noise generator as a third sound source alongside primary and modulator oscillators. The noise source includes its own envelope/VCA layer and can modulate the primary and modulator oscillators in addition to mixing directly into the signal path.

## Design Goals

- Noise source as independent third oscillator
- **Dedicated EG > VCA stage for noise** (shapes noise before any routing)
- **Noise → oscillator modulation** (NP, NM params for FM-style noise modulation)
- Individual volume controls for each source (PV, MV, NV)
- All sources mix before filter input
- Multiple noise types (white, pink, brown)
- Clean gain staging throughout signal path

## Signal Flow

### New Architecture
```
                         ┌─────────────────────────┐
                         │    NOISE GENERATOR      │
   NW (type) ───────────>│  White/Pink/Brown       │
                         └───────────┬─────────────┘
                                     │
                         ┌───────────v─────────────┐
   NA (attack) ─────────>│                         │
   ND (decay) ──────────>│    NOISE EG > VCA       │
   NC (curve) ──────────>│  (shapes noise first)   │
   NE (amount) ─────────>│                         │
                         └───────────┬─────────────┘
                                     │
              ┌──────────────────────┼──────────────────────┐
              │                      │                      │
              v                      v                      v
         NP (amount)            NM (amount)            NV (level)
              │                      │                      │
              v                      v                      │
    ┌─────────────────┐    ┌─────────────────┐              │
    │  PRIMARY OSC    │    │  MODULATOR OSC  │              │
    │  (FM from noise)│    │  (FM from noise)│              │
    └────────┬────────┘    └────────┬────────┘              │
             │                      │                       │
    PV ─────>×             MV ─────>×                       │
             │                      │                       │
             └──────────┬───────────┘                       │
                        │                                   │
                        v                                   │
                  ┌─────────────┐                           │
                  │     SUM     │<──────────────────────────┘
                  └──────┬──────┘
                         │
                         v
                   [Distortion → LoFi → Filter → VCA → FX]
```

## New Parameters

### Noise Generator

| Parameter | Command | Range | Default | Description |
|-----------|---------|-------|---------|-------------|
| `nw` | `NW` / `NOISE.WAV` | 0-2 | 0 | Noise type (0=white, 1=pink, 2=brown) |

### Noise Envelope (full ADSR-style control)

| Parameter | Command | Range | Default | Description |
|-----------|---------|-------|---------|-------------|
| `na` | `NA` / `NOEV.ATK` | 1-10000 | 1 | Noise envelope attack (ms) |
| `nd` | `ND` / `NOEV.DEC` | 1-10000 | 100 | Noise envelope decay (ms) |
| `nc` | `NC` / `NOEV.CRV` | -8 to 8 | -4 | Noise envelope curve |
| `ne` | `NE` / `NOISE.ENV` | 0-16383 | 16383 | Noise envelope amount (0=bypass) |

### Noise → Oscillator Routing (NEW)

| Parameter | Command | Range | Default | Description |
|-----------|---------|-------|---------|-------------|
| `np` | `NP` / `NOISE.PRI` | 0-16383 | 0 | Noise → primary osc FM amount |
| `nm` | `NM` / `NOISE.MOD` | 0-16383 | 0 | Noise → modulator osc FM amount |

### Source Level Controls

| Parameter | Command | Range | Default | Description |
|-----------|---------|-------|---------|-------------|
| `pv` | `PV` / `PRI.VOL` | 0-16383 | 16383 | Primary osc level |
| `mv` | `MV` / `MOD.VOL` | 0-16383 | 0 | Modulator osc level |
| `nv` | `NV` / `NOISE.VOL` | 0-16383 | 0 | Noise level (post-EG) |

## Implementation

### Task 1: SynthDef - Noise Generator + EG

**File:** `sc/monokit_server.scd`

1. Add parameters:
```supercollider
// Noise parameters
nw = 0,      // Noise waveform (0=white, 1=pink, 2=brown)
na = 1,      // Noise envelope attack (ms)
nd = 100,    // Noise envelope decay (ms)
nc = -4,     // Noise envelope curve
ne = 16383,  // Noise envelope amount (0=bypass env)
np = 0,      // Noise -> primary FM amount
nm = 0,      // Noise -> modulator FM amount
nv = 0,      // Noise output level
pv = 16383,  // Primary volume
mv = 0,      // Modulator volume
```

2. Add smoothing:
```supercollider
var nwVal = nw.clip(0, 2).round;
var naSmooth = Lag.kr(na, 0.01);
var ndSmooth = Lag.kr(nd, 0.01);
var ncVal = nc.clip(-8, 8);
var neSmooth = Lag.kr(ne / 16383, 0.01);
var npSmooth = Lag.kr(np / 16383, 0.01);
var nmSmooth = Lag.kr(nm / 16383, 0.01);
var nvSmooth = Lag.kr(nv / 16383, 0.01);
var pvSmooth = Lag.kr(pv / 16383, 0.01);
var mvSmooth = Lag.kr(mv / 16383, 0.01);
```

3. Generate noise with EG > VCA (before oscillators):
```supercollider
// Noise generator
var noiseRaw = Select.ar(nwVal, [
    WhiteNoise.ar(1),
    PinkNoise.ar(1),
    BrownNoise.ar(1)
]);

// Noise envelope (full ATK/DEC/CRV control)
var noiseEnv = EnvGen.kr(
    Env.perc(naSmooth / 1000, ndSmooth / 1000, 1, ncVal),
    t_gate
);

// Shaped noise (EG > VCA applied)
// ne controls envelope amount: 0=bypass (constant), 16383=full envelope
var noiseShaped = noiseRaw * ((1 - neSmooth) + (neSmooth * noiseEnv));
// When ne=0: constant level (bypass envelope)
// When ne=16383: full envelope shaping
```

4. Apply noise to oscillators (before osc generation):
```supercollider
// Noise modulation amounts
var noiseToPrimary = noiseShaped * npSmooth * 1000;   // ±1000 Hz FM
var noiseToMod = noiseShaped * nmSmooth * 1000;       // ±1000 Hz FM

// Modify oscillator frequencies
var primaryFreqWithNoise = primaryFreq + noiseToPrimary;
var modFreqWithNoise = modulatorFreq + noiseToMod;
```

5. Mix sources with individual levels:
```supercollider
// Individual level mixing with gain compensation
var totalLevel = (pvSmooth + mvSmooth + nvSmooth).max(0.001);
var gainComp = 1 / totalLevel.sqrt;

sig = (
    (primaryOsc * pvSmooth) +
    (modOsc * mvSmooth) +
    (noiseShaped * nvSmooth)
) * gainComp.clip(0.5, 1.5);
```

### Task 2: Backward Compatibility for MX

Keep MX functional by detecting legacy mode:

```supercollider
// Legacy MX mode: when mx > 0, use crossfade behavior
var useLegacyMix = (mx > 0) & (pv == 16383) & (mv == 0) & (nv == 0);
var legacyMixAmount = (mxSmooth / 16383);

// Choose between legacy (MX) and new (PV/MV/NV) mixing
sig = Select.ar(useLegacyMix, [
    // New mode: individual levels
    (primaryOsc * pvSmooth) + (modOsc * mvSmooth) + (noiseShaped * nvSmooth),
    // Legacy mode: crossfade
    (primaryOsc * (1 - legacyMixAmount)) + (modOsc * legacyMixAmount)
]) * gainComp.clip(0.5, 1.5);
```

### Task 3: Rust Command Handlers

**File:** `src/commands/synth/noise.rs` (new)

```rust
use super::common::{define_int_param, define_int_param_ms, define_mode_param, define_signed_param};

// Noise waveform (0-2)
define_mode_param!(handle_nw, "nw", 0, 2, "NW",
    "NOISE TYPE MUST BE 0 (WHITE), 1 (PINK), OR 2 (BROWN)",
    "NOISE TYPE", "Failed to parse noise type");

// Noise envelope attack (1-10000ms)
define_int_param_ms!(handle_na, "na", 1, 10000, "NA",
    "NOISE ENV ATTACK", "Failed to parse noise envelope attack");

// Noise envelope decay (1-10000ms)
define_int_param_ms!(handle_nd, "nd", 1, 10000, "ND",
    "NOISE ENV DECAY", "Failed to parse noise envelope decay");

// Noise envelope curve (-8 to 8)
define_signed_param!(handle_nc, "nc", -8, 8, "NC",
    "NOISE ENV CURVE", "Failed to parse noise envelope curve");

// Noise envelope amount (0-16383)
define_int_param!(handle_ne, "ne", 0, 16383, "NE",
    "NOISE ENV AMOUNT", "Failed to parse noise envelope amount");

// Noise -> primary FM (0-16383)
define_int_param!(handle_np, "np", 0, 16383, "NP",
    "NOISE -> PRIMARY", "Failed to parse noise to primary");

// Noise -> modulator FM (0-16383)
define_int_param!(handle_nm, "nm", 0, 16383, "NM",
    "NOISE -> MODULATOR", "Failed to parse noise to modulator");

// Noise volume (0-16383)
define_int_param!(handle_nv, "nv", 0, 16383, "NV",
    "NOISE VOLUME", "Failed to parse noise volume");
```

**File:** `src/commands/synth/source_levels.rs` (new)

```rust
use super::common::define_int_param;

// Primary volume (0-16383)
define_int_param!(handle_pv, "pv", 0, 16383, "PV",
    "PRIMARY VOLUME", "Failed to parse primary volume");

// Modulator volume (0-16383)
define_int_param!(handle_mv, "mv", 0, 16383, "MV",
    "MODULATOR VOLUME", "Failed to parse modulator volume");
```

### Task 4: Add Aliases

**File:** `src/commands/aliases.rs`

```rust
// Noise controls
m.insert("NOISE.WAV", "NW");
m.insert("NOEV.ATK", "NA");
m.insert("NOEV.DEC", "ND");
m.insert("NOEV.CRV", "NC");
m.insert("NOISE.ENV", "NE");
m.insert("NOISE.PRI", "NP");
m.insert("NOISE.MOD", "NM");
m.insert("NOISE.VOL", "NV");

// Source levels
m.insert("PRI.VOL", "PV");
m.insert("MOD.VOL", "MV");
```

### Task 5: Update Help System

**File:** `src/ui/pages/help_content.rs`

```
# NOISE
  NW <0-2>           NOISE TYPE (0=WHT 1=PNK 2=BRN)
  NA <1-10000>       NOISE ENV ATTACK (MS)
  ND <1-10000>       NOISE ENV DECAY (MS)
  NC <-8 to 8>       NOISE ENV CURVE
  NE <0-16383>       NOISE ENV AMOUNT (0=BYPASS)
  NP <0-16383>       NOISE -> PRIMARY OSC FM
  NM <0-16383>       NOISE -> MODULATOR OSC FM
  NV <0-16383>       NOISE VOLUME

# SOURCE LEVELS
  PV <0-16383>       PRIMARY OSC VOLUME
  MV <0-16383>       MODULATOR OSC VOLUME
```

### Task 6: Add to Reset

**File:** `src/commands/system/misc.rs`

```rust
// In handle_rst - noise params
send_osc("nw", 0);      // White noise
send_osc("na", 1);      // 1ms attack
send_osc("nd", 100);    // 100ms decay
send_osc("nc", -4);     // Exponential curve
send_osc("ne", 16383);  // Full envelope
send_osc("np", 0);      // No noise -> primary
send_osc("nm", 0);      // No noise -> modulator
send_osc("nv", 0);      // Noise off

// Source levels
send_osc("pv", 16383);  // Primary full
send_osc("mv", 0);      // Modulator off
```

## Files to Create/Modify

| File | Action |
|------|--------|
| `sc/monokit_server.scd` | Add noise gen, EG>VCA, osc routing, source levels |
| `src/commands/synth/noise.rs` | New - NW, NE, NED, NP, NM, NV handlers |
| `src/commands/synth/source_levels.rs` | New - PV, MV handlers |
| `src/commands/synth/mod.rs` | Export new modules |
| `src/commands/aliases.rs` | Add aliases |
| `src/commands/mod.rs` | Route new commands |
| `src/commands/validate.rs` | Add validation |
| `src/commands/system/misc.rs` | Add to RST |
| `src/ui/pages/help_content.rs` | Add help sections |
| `build_scripts/compile_synthdefs.scd` | Update compiled version |

## Testing

### Noise EG > VCA Tests
1. `NW 0/1/2` - verify different noise colors
2. `NA 1 ND 100 NC -4` - short percussive noise
3. `NA 500 ND 1000` - slow attack/decay
4. `NC 4` - linear-ish curve vs `NC -8` exponential
5. `NE 0` - bypass envelope (constant level)
6. `NE 16383` - full envelope shaping

### Noise → Oscillator Routing Tests
1. `NP 8000` - noise modulates primary pitch
2. `NM 8000` - noise modulates modulator pitch
3. `NP 4000 NM 4000` - both oscillators modulated
4. Verify NE/NED shapes the modulation signal

### Source Level Tests
1. `PV 16383 MV 0 NV 0` - primary only (default)
2. `PV 0 MV 16383` - modulator only
3. `PV 0 MV 0 NV 16383` - noise only
4. `PV 8000 MV 8000 NV 4000` - all three mixed
5. Verify gain compensation prevents clipping

### Backward Compatibility
1. Scenes using MX still work
2. `MX 8000` behaves as crossfade when PV/MV at defaults

## Implementation Order

1. **Noise Generator + EG > VCA** - core noise with envelope shaping
2. **NV (noise volume)** - noise into mix bus
3. **PV, MV (source levels)** - individual osc levels
4. **NP, NM (noise routing)** - noise → oscillator FM
5. **Help + RST updates**
6. **Testing**
